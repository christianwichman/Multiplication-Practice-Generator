<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multiplication Practice (1–20 × 1–20)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- html2canvas for exporting the worksheet as an image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { margin: 0; padding: 16px; background: #f4f6ff; display: flex; justify-content: center; }
    .page { max-width: 900px; width: 100%; }
    .controls-bar { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn {
      border: none; border-radius: 999px; padding: 6px 12px; font-size: 0.85rem;
      cursor: pointer; background: #4a7dff; color: white; font-weight: 500;
    }
    .btn.secondary { background: white; color: #325; border: 1px solid #c0cffc; }
    .btn.small { padding: 4px 8px; font-size: 0.75rem; }
    #worksheet {
      background: white; border-radius: 12px; padding: 16px 20px 20px;
      border: 1px solid #dde4ff; box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .worksheet-header {
      display: flex; justify-content: space-between; border-bottom: 1px solid #e0e5ff;
      padding-bottom: 8px; margin-bottom: 10px;
    }
    .worksheet-meta { text-align: right; font-size: 0.8rem; display: flex; flex-direction: column; gap: 2px; }
    .problems-grid {
      display: grid; grid-template-columns: repeat(4,1fr); gap: 12px;
    }
    .problem-card {
      border-radius: 8px; border: 1px solid #d5ddff; padding: 8px; background: #f8f9ff;
      display: flex; flex-direction: column;
    }
    .problem-top { display: flex; justify-content: space-between; align-items: center; }
    .answer-input { width: 70px; text-align: center; }
    .feedback { font-size: 0.8rem; min-height: 1em; }
    .correct { color: #1a8a2b; }
    .incorrect { color: #d23b3b; }
  </style>
</head>
<body>

  <div class="page">
    <div class="controls-bar">
      <button class="btn secondary" id="newBtn">New Questions</button>
      <button class="btn" id="exportBtn">Export as JPG</button>
    </div>

    <div id="worksheet">
      <div class="worksheet-header">
        <div>
          <div><strong>Multiplication Practice (1–20 × 1–20)</strong></div>
          <div>Multiply the two numbers and press Check on each question.</div>
        </div>
        <div class="worksheet-meta">
          <div id="dateDisplay"></div>
          <div id="timerDisplay">Time: --:--</div>
          <div id="bestTimeDisplay">Best today: --:--</div>
        </div>
      </div>

      <div class="problems-grid" id="problemsGrid"></div>
    </div>
  </div>

<script>
const NUM_PROBLEMS = 12;
const problemsGrid = document.getElementById("problemsGrid");
const newBtn = document.getElementById("newBtn");
const exportBtn = document.getElementById("exportBtn");
const dateDisplay = document.getElementById("dateDisplay");
const timerDisplay = document.getElementById("timerDisplay");
const bestTimeDisplay = document.getElementById("bestTimeDisplay");

let problems = [];
let timerStart = null;
let timerEnd = null;
let timerInterval = null;

function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function resetTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  timerStart = null;
  timerEnd = null;
  timerDisplay.textContent = "Time: --:--";
}

function formatTime(ms) {
  const s = Math.floor(ms / 1000);
  return String(Math.floor(s / 60)).padStart(2, "0") + ":" + String(s % 60).padStart(2, "0");
}

function startTimerIfNeeded() {
  if (timerStart === null) {
    timerStart = Date.now();
    timerInterval = setInterval(updateTimer, 250);
  }
}

function updateTimer() {
  if (timerStart !== null && timerEnd === null) {
    timerDisplay.textContent = "Time: " + formatTime(Date.now() - timerStart);
  }
}

function stopTimerIfAllCorrect() {
  const cards = document.querySelectorAll(".problem-card");
  const allCorrect = Array.from(cards).every(card =>
    card.querySelector(".feedback").classList.contains("correct")
  );

  if (allCorrect && timerEnd === null && timerStart !== null) {
    timerEnd = Date.now();
    clearInterval(timerInterval);
    timerDisplay.textContent = "Final time: " + formatTime(timerEnd - timerStart);
    saveBestTime(timerEnd - timerStart);
  }
}

function todayKey() {
  return "best-" + new Date().toISOString().slice(0,10);
}

function loadBestTime() {
  const ms = localStorage.getItem(todayKey());
  if (ms) bestTimeDisplay.textContent = "Best today: " + formatTime(parseInt(ms));
}

function saveBestTime(ms) {
  const stored = localStorage.getItem(todayKey());
  if (!stored || ms < parseInt(stored)) {
    localStorage.setItem(todayKey(), String(ms));
    bestTimeDisplay.textContent = "Best today: " + formatTime(ms);
  }
}

function generateProblems() {
  problemsGrid.innerHTML = "";
  problems = [];
  resetTimer();

  for (let i = 0; i < NUM_PROBLEMS; i++) {
    const a = randomInt(1, 20);
    const b = randomInt(1, 20);
    const product = a * b;

    problems.push({ a, b, product });

    const card = document.createElement("div");
    card.className = "problem-card";
    card.dataset.index = i;

    card.innerHTML = `
      <div class="problem-top">
        <div>${a} × ${b} = <input class="answer-input" type="number"></div>
        <button class="btn small checkBtn">Check</button>
      </div>
      <div class="feedback"></div>
    `;

    problemsGrid.appendChild(card);

    const input = card.querySelector(".answer-input");
    const checkBtn = card.querySelector(".checkBtn");

    input.addEventListener("input", () => {
      startTimerIfNeeded();
    });

    checkBtn.addEventListener("click", () => {
      checkSingle(card);
      stopTimerIfAllCorrect();
    });
  }
}

function checkSingle(card) {
  const index = parseInt(card.dataset.index);
  const { product } = problems[index];
  const input = card.querySelector(".answer-input");
  const fb = card.querySelector(".feedback");

  if (parseInt(input.value) === product) {
    fb.textContent = "✔️ Correct!";
    fb.classList.add("correct");
    fb.classList.remove("incorrect");
  } else {
    fb.textContent = "❌ Try again";
    fb.classList.add("incorrect");
    fb.classList.remove("correct");
  }
}

function exportWorksheetAsJPG() {
  html2canvas(document.getElementById("worksheet"), {
    backgroundColor: "#ffffff",
    scale: 2
  }).then(canvas => {
    const link = document.createElement("a");
    link.download = "multiplication.jpg";
    link.href = canvas.toDataURL("image/jpeg", 0.9);
    link.click();
  });
}

function setTodayDate() {
  dateDisplay.textContent = new Date().toLocaleDateString(undefined, {
    year: "numeric", month: "short", day: "numeric"
  });
}

// Init
newBtn.addEventListener("click", generateProblems);
exportBtn.addEventListener("click", exportWorksheetAsJPG);

setTodayDate();
loadBestTime();
generateProblems();
</script>

</body>
</html>
